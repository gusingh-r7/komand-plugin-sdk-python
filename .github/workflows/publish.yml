name: Publish Plugin Runtime

on:
  push:
    tags:
    - '*'

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]
    steps:
        - uses: actions/checkout@v1
        - name: Setup Python ${{ matrix.python-version }}
          uses: actions/setup-python@v1
          with:
            python-version: ${{ matrix.python-version }}
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip coverage
        - name: Install Tox
          run: pip install tox tox-gh-actions
        - name: Run Tox
          run: tox
        - name: Package dependencies
          run: |
            python3 -m pip install --user --upgrade setuptools wheel twine
        - name: Package
          run: |
            rm -rf dist/
            python3 setup.py sdist bdist_wheel
        - name: PyPi Test Upload
          env:
            TWINE_USERNAME: ${{ secrets.PYPI_TEST_USERNAME }}
            TWINE_PASSWORD: ${{ secrets.PYPI_TEST_PASSWORD }}
          run: |
            python3 -m twine upload --repository-url https://test.pypi.org/legacy/ dist/*