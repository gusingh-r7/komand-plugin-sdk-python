name: Publish Plugin Runtime

on:
  push:
    tags:
    - '*'

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]
    steps:
        - uses: actions/checkout@v1
        - name: Setup Python ${{ matrix.python-version }}
          uses: actions/setup-python@v1
          with:
            python-version: ${{ matrix.python-version }}
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip coverage
        - name: Install Tox
          run: pip install tox tox-gh-actions
        - name: Run Tox
          run: tox
        - name: Package dependencies
          run: |
            python3 -m pip install --user --upgrade setuptools wheel twine
        - name: Package
          run: |
            rm -rf dist/
            python3 setup.py sdist bdist_wheel
        - name: Get extension name
          id: get-extension-name
          run: |
            echo ::set-output name=extension-name::$(basename  dist/*.tar.gz)
        - name: Create Release
          id: create_release
          uses: actions/create-release@sdk-enhancements
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            tag_name: ${{ github.ref }}
            release_name: Release ${{ github.ref }}
            draft: false
            prerelease: false
        - name: Upload release asset
          id: upload-release-asset
          uses: actions/upload-release-asset@v1.0.1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ${{ steps.get-extension-name.outputs.extension-name }}
            asset_name: ${{ steps.get-extension-name.outputs.extension-name }}
            asset_content_type: application/gzip
        - name: PyPi Test Upload
          env:
            TWINE_USERNAME: ${{ secrets.PYPI_TEST_USERNAME }}
            TWINE_PASSWORD: ${{ secrets.PYPI_TEST_PASSWORD }}
          run: |
            python3 -m twine upload --repository-url https://test.pypi.org/legacy/ dist/*