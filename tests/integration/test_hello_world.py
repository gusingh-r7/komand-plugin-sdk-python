#!/usr/bin/env python
# GENERATED BY KOMAND SDK - DO NOT EDIT
import komand
import komand.handler
import json
import time

import concurrent.futures.thread as thread
import concurrent.futures as futures


Name = 'HelloWorld'
Vendor = 'komand'
Version = '1.0.0'
Description = 'Hello World plugin'

connection_schema = {
    'type': 'object',
    'properties': {
        'greeting': {
            'type': 'string'
        }
    },
    'required': ['greeting']
}

input_schema = {
    'type': 'object',
    'properties': {
        'name': {
            'type': 'string'
        }
    },
    'required': ['name']
}

output_schema = {
    'type': 'object',
    'properties': {
        'text': {
            'type': 'string'
        }
    },
    'required': ['text']
}


class Connection(komand.Connection):
    def __init__(self):
        super(self.__class__, self).__init__(komand.Input(connection_schema))
        self.greeting = None

    def connect(self, params={}):
        self.greeting = params.get('greeting', 'no greeting for {}')


class Action(komand.Action):

    def __init__(self):
        super(self.__class__, self).__init__(
            name='action',
            description='description',
            input=komand.Input(schema=input_schema),
            output=komand.Output(schema=output_schema)
        )

    def run(self, params={}):
        self.logger.info(u'I am the log')
        return {
            'text': self.connection.greeting.format(params['name'])
        }


class Trigger(komand.Trigger):

    def __init__(self):
        super(self.__class__, self).__init__(
            name='trigger',
            description='description',
            input=komand.Input(schema=input_schema),
            output=komand.Output(schema=output_schema)
        )

    def run(self, params={}):
        while True:
            self.logger.info(u'I am the log')
            self.send({
                'text': self.connection.greeting.format(params['name'])
            })
            time.sleep(10)


class Plugin(komand.Plugin):
    def __init__(self):
        super(self.__class__, self).__init__(
            name=Name,
            vendor=Vendor,
            version=Version,
            description=Description,
            connection=Connection()
        )

        self.add_action(Action())

        self.add_trigger(Trigger())


caught_message = None


def wait_for_caught_message():
    while True:
        if caught_message:
            return caught_message
        time.sleep(1)


class CaptureDispatcher:

    def write(self, msg):
        global caught_message
        caught_message = msg


plugin = Plugin()
handler = komand.handler.StepHandler(plugin)
plugin.triggers['trigger'].dispatcher = CaptureDispatcher()


def test_action():
    input_message = json.load(open('./tests/integration/action/input.json'))
    expected_output = json.load(open('./tests/integration/action/output.json'))
    output = handler.handle_step(input_message)
    assert output == expected_output


def test_trigger():
    input_message = json.load(open('./tests/integration/trigger/input.json'))
    expected_output = json.load(open('./tests/integration/trigger/output.json'))

    executor = thread.ThreadPoolExecutor()
    executor.submit(handler.handle_step, input_message, is_debug=True)
    future = executor.submit(wait_for_caught_message)
    out = futures.wait([future], timeout=10)
    done = out.done

    # Non-graceful shutdown
    executor._threads.clear()
    futures.thread._threads_queues.clear()

    if len(done) <= 0:
        raise Exception('Timeout')

    assert caught_message == expected_output
